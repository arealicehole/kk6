<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KK6 Visual Pipeline Management</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-600: #4b5563;
            --gray-800: #1f2937;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray-100);
            color: var(--gray-800);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            color: var(--gray-600);
        }

        /* Upload Area */
        .upload-section {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
        }

        .upload-area {
            border: 2px dashed var(--gray-300);
            border-radius: 8px;
            padding: 60px 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            background: #f8faff;
        }

        .upload-area.dragover {
            border-color: var(--primary-color);
            background: #f8faff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            color: var(--gray-600);
        }

        .upload-text {
            font-size: 1.2rem;
            color: var(--gray-600);
            margin-bottom: 20px;
        }

        .upload-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .upload-button:hover {
            background: #1d4ed8;
        }

        /* Pipeline Visualization */
        .pipeline-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
        }

        .pipeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .pipeline-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--gray-800);
        }

        .pipeline-meta {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
            color: var(--gray-600);
        }

        .stages-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .stage {
            background: var(--gray-100);
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid var(--gray-300);
            transition: all 0.3s ease;
        }

        .stage.pending {
            border-left-color: var(--gray-300);
        }

        .stage.active {
            border-left-color: var(--warning-color);
            background: #fffbeb;
        }

        .stage.complete {
            border-left-color: var(--success-color);
            background: #ecfdf5;
        }

        .stage.failed {
            border-left-color: var(--error-color);
            background: #fef2f2;
        }

        .stage-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stage-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--gray-800);
        }

        .stage-icon {
            font-size: 1.5rem;
            margin-right: 10px;
        }

        .stage.pending .stage-icon { color: var(--gray-300); }
        .stage.active .stage-icon { color: var(--warning-color); }
        .stage.complete .stage-icon { color: var(--success-color); }
        .stage.failed .stage-icon { color: var(--error-color); }

        .progress-container {
            margin-bottom: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            border-radius: 4px;
            transition: width 0.5s ease;
            width: 0%;
        }

        .stage.active .progress-fill {
            background: var(--warning-color);
        }

        .stage.complete .progress-fill {
            background: var(--success-color);
            width: 100% !important;
        }

        .stage.failed .progress-fill {
            background: var(--error-color);
        }

        .stage-message {
            font-size: 0.9rem;
            color: var(--gray-600);
            margin-bottom: 10px;
        }

        .stage-data {
            display: none;
            font-size: 0.85rem;
            color: var(--gray-600);
            background: white;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .stage.active .stage-data,
        .stage.complete .stage-data {
            display: block;
        }

        /* Data Visualization Panels */
        .data-panels {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }

        .data-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .panel-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--gray-200);
        }

        .category-item:last-child {
            border-bottom: none;
        }

        .category-name {
            font-weight: 500;
        }

        .category-count {
            background: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-pending { background: var(--gray-300); }
        .status-active { background: var(--warning-color); }
        .status-complete { background: var(--success-color); }
        .status-failed { background: var(--error-color); }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .stages-grid {
                grid-template-columns: 1fr;
            }

            .data-panels {
                grid-template-columns: 1fr;
            }

            .upload-area {
                padding: 40px 20px;
            }
        }

        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .stage.active .stage-icon {
            animation: pulse 2s infinite;
        }

        .hidden {
            display: none;
        }

        /* Merged Item Styles */
        .merged-item {
            border-left: 4px solid var(--warning-color);
            background: linear-gradient(135deg, #fff9e6, #ffffff);
        }

        .merge-info {
            margin: 10px 0;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .merge-badge {
            font-size: 0.75rem;
            font-weight: bold;
            color: var(--warning-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .merge-details {
            margin-top: 4px;
            font-size: 0.8rem;
            color: #6c757d;
        }

        .category-badge {
            display: inline-block;
            padding: 2px 6px;
            background: var(--primary-color);
            color: white;
            font-size: 0.7rem;
            border-radius: 12px;
            margin: 0 2px;
        }

        /* Enhanced confidence badges */
        .confidence-badge.high {
            background: var(--success-color);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .confidence-badge.medium {
            background: var(--warning-color);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .confidence-badge.low {
            background: var(--error-color);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        /* Approval Component Styles */
        .approval-section {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin: 30px 0;
            padding: 30px;
            border: 3px solid var(--success-color);
        }

        .approval-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--gray-200);
        }

        .approval-header h2 {
            color: var(--success-color);
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .approval-header p {
            color: var(--gray-600);
            font-size: 1.1rem;
        }

        .approval-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .summary-stat {
            background: var(--gray-50);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid transparent;
        }

        .summary-stat.total { border-color: var(--info-color); }
        .summary-stat.duplicates { border-color: var(--warning-color); }
        .summary-stat.unique { border-color: var(--success-color); }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--gray-600);
            font-size: 0.9rem;
        }

        .approval-items {
            max-height: 60vh;
            overflow-y: auto;
            padding: 10px 0;
        }

        .category-group {
            margin-bottom: 25px;
        }

        .category-header {
            background: var(--gray-100);
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-title {
            font-weight: 600;
            color: var(--gray-700);
            text-transform: capitalize;
        }

        .category-count {
            background: var(--primary-color);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        .approval-item {
            background: var(--gray-50);
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .approval-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.15);
        }

        .approval-item.approved {
            border-color: var(--success-color);
            background: rgba(34, 197, 94, 0.05);
        }

        .approval-item.declined {
            border-color: var(--error-color);
            background: rgba(239, 68, 68, 0.05);
        }

        .approval-item.edited {
            border-color: var(--warning-color);
            background: rgba(245, 158, 11, 0.05);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .item-content {
            flex: 1;
            margin-right: 15px;
        }

        .item-title {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 5px;
            color: var(--gray-700);
        }

        .item-description {
            color: var(--gray-600);
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .item-meta {
            display: flex;
            gap: 10px;
            font-size: 0.8rem;
            color: var(--gray-500);
            margin-top: 8px;
        }

        .confidence-badge {
            background: var(--success-color);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
        }

        .confidence-badge.medium { background: var(--warning-color); }
        .confidence-badge.low { background: var(--error-color); }

        .item-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 12px;
            white-space: nowrap;
        }

        .status-pending {
            background: var(--gray-200);
            color: var(--gray-600);
        }

        .status-approved {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success-color);
        }

        .status-declined {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error-color);
        }

        .status-edited {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning-color);
        }

        .status-skipped {
            background: rgba(148, 163, 184, 0.2);
            color: var(--gray-500);
        }

        .item-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-approve {
            background: var(--success-color);
            color: white;
        }

        .btn-edit {
            background: var(--warning-color);
            color: white;
        }

        .btn-decline {
            background: var(--error-color);
            color: white;
        }

        .btn-skip {
            background: var(--gray-400);
            color: white;
        }

        .edit-form {
            display: none;
            background: white;
            border: 2px solid var(--warning-color);
            border-radius: 6px;
            padding: 15px;
            margin-top: 10px;
        }

        .edit-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-label {
            display: block;
            margin-bottom: 3px;
            font-weight: 500;
            color: var(--gray-700);
            font-size: 0.9rem;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 8px;
            border: 2px solid var(--gray-200);
            border-radius: 4px;
            font-size: 0.9rem;
            transition: border-color 0.2s ease;
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-textarea {
            min-height: 60px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .btn-save {
            background: var(--success-color);
            color: white;
        }

        .btn-cancel {
            background: var(--gray-400);
            color: white;
        }

        .approval-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid var(--gray-200);
        }

        .btn-complete-approval {
            background: var(--primary-color);
            color: white;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-complete-approval:hover:not(:disabled) {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .btn-complete-approval:disabled {
            background: var(--gray-400);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .approval-progress {
            color: var(--gray-600);
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .approval-section {
                padding: 20px;
                margin: 20px 0;
            }

            .approval-summary {
                grid-template-columns: 1fr 1fr;
            }

            .item-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .item-content {
                margin-right: 0;
                margin-bottom: 10px;
            }

            .approval-actions {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üéØ KK6 Visual Pipeline Management</h1>
            <p>Advanced AI-powered extraction pipeline with real-time visualization</p>
        </div>

        <!-- Upload Section -->
        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">
                    Drag and drop transcript files here or click to select
                </div>
                <button class="upload-button" onclick="document.getElementById('fileInput').click()">
                    Choose File
                </button>
                <input type="file" id="fileInput" accept=".txt" style="display: none;">
            </div>
        </div>

        <!-- Router Agent Query Interface - Phase 1.1 Enhancement -->
        <div class="upload-section">
            <div style="text-align: center; margin-bottom: 30px;">
                <h2 style="color: var(--primary-color); margin-bottom: 10px;">üß† Intelligent Query Router</h2>
                <p style="color: var(--gray-600);">Ask questions about your planning data using natural language</p>
            </div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <input type="text" id="routerQuery" placeholder="e.g., 'Find items similar to entertainment planning' or 'How many items in each category?'" 
                       style="flex: 1; padding: 12px; border: 2px solid var(--gray-300); border-radius: 8px; font-size: 1rem;">
                <button id="executeQueryBtn" class="upload-button" style="flex-shrink: 0;">
                    üöÄ Execute Query
                </button>
            </div>
            
            <div id="routerResults" style="display: none; background: var(--gray-100); border-radius: 8px; padding: 20px; margin-top: 20px;">
                <div id="routerResultsContent"></div>
            </div>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
                <button class="example-query-btn" onclick="pipelineManager.executeExampleQuery('Find items similar to entertainment planning')">
                    üì± Find similar items
                </button>
                <button class="example-query-btn" onclick="pipelineManager.executeExampleQuery('How many items in each category?')">
                    üìä Category statistics
                </button>
                <button class="example-query-btn" onclick="pipelineManager.executeExampleQuery('Find duplicate planning items')">
                    üîÑ Find duplicates
                </button>
                <button class="example-query-btn" onclick="pipelineManager.executeExampleQuery('Analyze patterns in planning data')">
                    üß† Analyze patterns
                </button>
            </div>
        </div>

        <!-- Pipeline Visualization -->
        <div class="pipeline-section hidden" id="pipelineSection">
            <div class="pipeline-header">
                <div class="pipeline-title">üîÑ Processing Pipeline</div>
                <div class="pipeline-meta">
                    <div>Session: <span id="sessionId">-</span></div>
                    <div>Started: <span id="startTime">-</span></div>
                    <div>Status: <span id="overallStatus">Ready</span></div>
                </div>
            </div>

            <div class="stages-grid">
                <!-- Upload Stage -->
                <div class="stage pending" id="stage-upload">
                    <div class="stage-header">
                        <div class="stage-title">
                            <span class="stage-icon">üì§</span>
                            Document Upload
                        </div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill"></div>
                        </div>
                    </div>
                    <div class="stage-message">Ready for upload</div>
                    <div class="stage-data"></div>
                </div>

                <!-- Chunking Stage -->
                <div class="stage pending" id="stage-chunking">
                    <div class="stage-header">
                        <div class="stage-title">
                            <span class="stage-icon">üìù</span>
                            Document Processing
                        </div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill"></div>
                        </div>
                    </div>
                    <div class="stage-message">Waiting for upload</div>
                    <div class="stage-data"></div>
                </div>

                <!-- Embedding Stage -->
                <div class="stage pending" id="stage-embedding">
                    <div class="stage-header">
                        <div class="stage-title">
                            <span class="stage-icon">üß†</span>
                            Vector Embeddings
                        </div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill"></div>
                        </div>
                    </div>
                    <div class="stage-message">Waiting for processing</div>
                    <div class="stage-data"></div>
                </div>

                <!-- Extraction Stage -->
                <div class="stage pending" id="stage-extraction">
                    <div class="stage-header">
                        <div class="stage-title">
                            <span class="stage-icon">üéØ</span>
                            Category Extraction
                        </div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill"></div>
                        </div>
                    </div>
                    <div class="stage-message">Waiting for embeddings</div>
                    <div class="stage-data"></div>
                </div>

                <!-- Deduplication Stage -->
                <div class="stage pending" id="stage-deduplication">
                    <div class="stage-header">
                        <div class="stage-title">
                            <span class="stage-icon">üîÑ</span>
                            Deduplication Analysis
                        </div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill"></div>
                        </div>
                    </div>
                    <div class="stage-message">Waiting for extraction</div>
                    <div class="stage-data"></div>
                </div>

                <!-- Approval Stage -->
                <div class="stage pending" id="stage-approval">
                    <div class="stage-header">
                        <div class="stage-title">
                            <span class="stage-icon">‚úÖ</span>
                            User Approval
                        </div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill"></div>
                        </div>
                    </div>
                    <div class="stage-message">Waiting for deduplication</div>
                    <div class="stage-data"></div>
                </div>
            </div>
        </div>

        <!-- Data Visualization Panels -->
        <div class="data-panels hidden" id="dataPanels">
            <!-- Category Distribution -->
            <div class="data-panel">
                <div class="panel-title">
                    üìä Category Distribution
                </div>
                <div id="categoryData">
                    <div class="stage-message">No extraction data yet</div>
                </div>
            </div>

            <!-- Processing Metrics -->
            <div class="data-panel">
                <div class="panel-title">
                    ‚ö° Processing Metrics
                </div>
                <div id="metricsData">
                    <div class="stage-message">No metrics data yet</div>
                </div>
            </div>

            <!-- Deduplication Results -->
            <div class="data-panel">
                <div class="panel-title">
                    üîó Deduplication Results
                </div>
                <div id="deduplicationData">
                    <div class="stage-message">No deduplication data yet</div>
                </div>
            </div>
        </div>

        <!-- Approval Section (Hidden by default) -->
        <div id="approvalSection" class="approval-section hidden">
            <div class="approval-header">
                <h2>‚úÖ Review & Approve Extracted Items</h2>
                <p>Review extracted planning items and decide which ones to save to the database.</p>
                <div id="approvalSummary" class="approval-summary"></div>
            </div>
            
            <div id="approvalItems" class="approval-items"></div>
            
            <div class="approval-actions">
                <button id="completeApprovalBtn" class="btn-complete-approval" disabled>
                    üíæ Save Approved Items to Database
                </button>
                <div class="approval-progress">
                    <span id="approvalProgress">0 items reviewed</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        class PipelineManager {
            constructor() {
                this.ws = null;
                this.currentSessionId = null;
                this.categoryData = {};
                this.startTime = null;
                this.approvalData = null;
                this.decisions = {};
                this.initializeEventListeners();
                this.connectWebSocket();
            }

            initializeEventListeners() {
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');

                // Drag and drop handlers
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        this.uploadFile(files[0]);
                    }
                });

                uploadArea.addEventListener('click', () => {
                    fileInput.click();
                });

                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.uploadFile(e.target.files[0]);
                    }
                });

                // Approval button listener
                document.getElementById('completeApprovalBtn').addEventListener('click', () => {
                    this.completeApproval();
                });
            }

            connectWebSocket() {
                const clientId = Math.random().toString(36).substring(7);
                this.ws = new WebSocket(`ws://localhost:8091/ws/${clientId}`);
                
                this.ws.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    this.handleWebSocketMessage(message);
                };
                
                this.ws.onclose = () => {
                    console.log('WebSocket disconnected, reconnecting...');
                    setTimeout(() => this.connectWebSocket(), 1000);
                };

                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };
            }

            handleWebSocketMessage(message) {
                console.log('WebSocket message:', message);
                
                switch (message.type) {
                    case 'pipeline_update':
                        this.updatePipelineStage(message);
                        break;
                    case 'category_complete':
                        this.updateCategoryData(message);
                        break;
                    default:
                        console.log('Unknown message type:', message.type);
                }
            }

            async uploadFile(file) {
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`Upload failed: ${response.statusText}`);
                    }

                    const result = await response.json();
                    this.currentSessionId = result.session_id;
                    this.startTime = new Date();

                    // Update UI
                    document.getElementById('sessionId').textContent = result.session_id.substring(0, 8);
                    document.getElementById('startTime').textContent = this.startTime.toLocaleTimeString();
                    document.getElementById('overallStatus').textContent = 'Processing';

                    // Show pipeline section
                    document.getElementById('pipelineSection').classList.remove('hidden');
                    document.getElementById('dataPanels').classList.remove('hidden');

                } catch (error) {
                    console.error('Upload error:', error);
                    alert('Upload failed: ' + error.message);
                }
            }

            async loadExistingSession(sessionId) {
                try {
                    console.log('Loading existing session:', sessionId);
                    
                    // Set current session ID
                    this.currentSessionId = sessionId;
                    
                    // Update UI with session info
                    document.getElementById('sessionId').textContent = sessionId.substring(0, 8);
                    document.getElementById('startTime').textContent = 'Restored session';
                    
                    // Show pipeline section
                    document.getElementById('pipelineSection').classList.remove('hidden');
                    document.getElementById('dataPanels').classList.remove('hidden');
                    
                    // Get session status
                    const response = await fetch(`/sessions/${sessionId}`);
                    if (!response.ok) {
                        throw new Error(`Session not found: ${response.statusText}`);
                    }
                    
                    const sessionData = await response.json();
                    console.log('Session data:', sessionData);
                    
                    // Update overall status based on session stage
                    if (sessionData.stage === 'approval') {
                        document.getElementById('overallStatus').textContent = 'Awaiting Approval';
                        // Load approval interface directly
                        this.loadApprovalComponent();
                    } else if (sessionData.stage === 'completed') {
                        document.getElementById('overallStatus').textContent = 'Completed';
                    } else {
                        document.getElementById('overallStatus').textContent = 'Processing';
                    }
                    
                } catch (error) {
                    console.error('Error loading existing session:', error);
                    alert(`Failed to load session: ${error.message}`);
                }
            }

            updatePipelineStage(update) {
                if (update.session_id !== this.currentSessionId) return;

                const stageElement = document.getElementById(`stage-${update.stage}`);
                if (!stageElement) return;

                // Update progress bar
                const progressFill = stageElement.querySelector('.progress-fill');
                progressFill.style.width = `${update.progress * 100}%`;

                // Update status message
                const statusMessage = stageElement.querySelector('.stage-message');
                statusMessage.textContent = update.message;

                // Update stage data if available
                const stageData = stageElement.querySelector('.stage-data');
                if (update.data && Object.keys(update.data).length > 0) {
                    stageData.innerHTML = this.formatStageData(update.data);
                }

                // Update stage class
                stageElement.className = 'stage';
                if (update.progress === 1.0) {
                    stageElement.classList.add('complete');
                } else if (update.progress > 0) {
                    stageElement.classList.add('active');
                } else {
                    stageElement.classList.add('pending');
                }

                // Handle approval stage - show inline approval component
                if (update.stage === 'approval' && update.progress === 0.0 && update.message === 'Ready for user approval') {
                    // Use the analysis data from the WebSocket message if available
                    if (update.data && update.data.analysis) {
                        this.approvalData = {
                            session_id: this.currentSessionId,
                            extraction_session_id: update.data.extraction_session_id,
                            analysis: update.data.analysis
                        };
                        this.renderApprovalComponent();
                        document.getElementById('approvalSection').classList.remove('hidden');
                        document.getElementById('approvalSection').scrollIntoView({ 
                            behavior: 'smooth',
                            block: 'start'
                        });
                    } else {
                        // Fallback to API call if data not in WebSocket message
                        this.loadApprovalComponent();
                    }
                }

                // Update overall status
                if (update.stage === 'completed') {
                    document.getElementById('overallStatus').textContent = 'Completed';
                } else if (update.stage === 'failed') {
                    document.getElementById('overallStatus').textContent = 'Failed';
                    stageElement.classList.add('failed');
                } else if (update.stage === 'approval') {
                    document.getElementById('overallStatus').textContent = 'Awaiting Approval';
                }
            }

            updateCategoryData(categoryUpdate) {
                if (!this.categoryData[categoryUpdate.category]) {
                    this.categoryData[categoryUpdate.category] = {
                        items: 0,
                        confidence: 0
                    };
                }

                this.categoryData[categoryUpdate.category] = {
                    items: categoryUpdate.items_count,
                    confidence: categoryUpdate.confidence_avg
                };

                this.renderCategoryData();
            }

            renderCategoryData() {
                const categoryDataElement = document.getElementById('categoryData');
                
                if (Object.keys(this.categoryData).length === 0) {
                    categoryDataElement.innerHTML = '<div class="stage-message">No extraction data yet</div>';
                    return;
                }

                let html = '';
                for (const [category, data] of Object.entries(this.categoryData)) {
                    html += `
                        <div class="category-item">
                            <span class="category-name">${category.replace('_', ' ')}</span>
                            <span class="category-count">${data.items} items</span>
                        </div>
                    `;
                }

                categoryDataElement.innerHTML = html;
            }

            formatStageData(data) {
                let html = '<strong>Stage Data:</strong><br>';
                for (const [key, value] of Object.entries(data)) {
                    html += `‚Ä¢ ${key}: ${value}<br>`;
                }
                return html;
            }

            async loadApprovalComponent() {
                try {
                    const response = await fetch(`/api/sessions/${this.currentSessionId}/extraction-results`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    this.approvalData = await response.json();
                    this.renderApprovalComponent();
                    
                    // Show the approval section
                    document.getElementById('approvalSection').classList.remove('hidden');
                    
                    // Scroll to approval section
                    document.getElementById('approvalSection').scrollIntoView({ 
                        behavior: 'smooth',
                        block: 'start'
                    });
                    
                } catch (error) {
                    console.error('Error loading approval component:', error);
                    document.getElementById('approvalSection').innerHTML = `
                        <div style="text-align: center; color: var(--error-color); padding: 30px;">
                            <h3>‚ùå Error Loading Approval Data</h3>
                            <p>${error.message}</p>
                            <button onclick="window.location.reload()" class="action-btn btn-approve" style="margin-top: 15px;">
                                Retry
                            </button>
                        </div>
                    `;
                    document.getElementById('approvalSection').classList.remove('hidden');
                }
            }

            renderApprovalComponent() {
                const analysis = this.approvalData.analysis;
                
                // Render summary stats
                const summaryHtml = `
                    <div class="summary-stat total">
                        <div class="stat-number">${analysis.summary.total_items}</div>
                        <div class="stat-label">Total Items</div>
                    </div>
                    <div class="summary-stat duplicates">
                        <div class="stat-number">${analysis.summary.duplicate_groups}</div>
                        <div class="stat-label">Duplicate Groups</div>
                    </div>
                    <div class="summary-stat unique">
                        <div class="stat-number">${analysis.summary.unique_items}</div>
                        <div class="stat-label">Unique Items</div>
                    </div>
                `;
                document.getElementById('approvalSummary').innerHTML = summaryHtml;
                
                // Render categorized items
                this.renderApprovalItems(analysis.items_by_category);
                
                // Update progress
                this.updateApprovalProgress();
            }

            renderApprovalItems(itemsByCategory) {
                const container = document.getElementById('approvalItems');
                container.innerHTML = '';
                
                let globalItemCounter = 1; // Global counter for unique IDs
                
                for (const [category, items] of Object.entries(itemsByCategory)) {
                    if (!items || items.length === 0) continue;

                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'category-group';
                    categoryDiv.innerHTML = `
                        <div class="category-header">
                            <div class="category-title">${category.replace(/_/g, ' ')}</div>
                            <div class="category-count">${items.length} items</div>
                        </div>
                    `;

                    items.forEach(item => {
                        // Ensure each item has a unique ID
                        if (!item.id || item.id === null) {
                            item.id = `item-${globalItemCounter++}`;
                        }
                        const itemDiv = this.createApprovalItem(item);
                        categoryDiv.appendChild(itemDiv);
                    });

                    container.appendChild(categoryDiv);
                }
            }

            createApprovalItem(item) {
                console.log('Creating approval item for:', item);
                console.log('Item ID:', item.id);
                console.log('Item object keys:', Object.keys(item));
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'approval-item';
                
                // Add merged class if this is a merged item
                if (item.is_merged) {
                    itemDiv.classList.add('merged-item');
                }
                
                itemDiv.dataset.itemId = item.result_id || item.id;

                const content = item.content;
                const title = content.title || content.task || content.name || 'Untitled Item';
                const description = content.description || content.details || content.notes || 'No description available';
                
                const confidence = item.confidence_score || item.confidence || 0;
                const confidenceClass = confidence >= 0.8 ? 'high' : confidence >= 0.6 ? 'medium' : 'low';

                // Create merge info section
                let mergeInfo = '';
                if (item.is_merged && item.merged_from_categories && item.merged_from_categories.length > 0) {
                    const categoryBadges = item.merged_from_categories.map(cat => `<span class="category-badge">${cat}</span>`).join(' + ');
                    mergeInfo = `
                        <div class="merge-info">
                            <div class="merge-badge">üîÑ MERGED ITEM</div>
                            <div class="merge-details">
                                <small>Combined from: ${categoryBadges}</small>
                                ${item.merge_rationale ? `<br><small>Reason: ${item.merge_rationale}</small>` : ''}
                            </div>
                        </div>
                    `;
                }

                itemDiv.innerHTML = `
                    <div class="item-header">
                        <div class="item-content">
                            <div class="item-title">${title}</div>
                            <div class="item-description">${description}</div>
                            ${mergeInfo}
                            <div class="item-meta">
                                <span>Confidence: <span class="confidence-badge ${confidenceClass}">${Math.round(confidence * 100)}%</span></span>
                                <span>Chunks: ${item.chunk_ids ? item.chunk_ids.length : 0}</span>
                                ${item.is_merged ? '<span>Type: Merged</span>' : ''}
                            </div>
                        </div>
                        <div class="item-status status-pending" id="status-${item.result_id || item.id}">
                            ‚è≥ Pending
                        </div>
                    </div>

                    <div class="item-actions">
                        <button class="action-btn btn-approve" onclick="pipelineManager.approveItem('${item.result_id || item.id}')">
                            ‚úÖ Approve
                        </button>
                        <button class="action-btn btn-edit" onclick="pipelineManager.editItem('${item.result_id || item.id}')">
                            ‚úèÔ∏è Edit
                        </button>
                        <button class="action-btn btn-decline" onclick="pipelineManager.declineItem('${item.result_id || item.id}')">
                            ‚ùå Decline
                        </button>
                        <button class="action-btn btn-skip" onclick="pipelineManager.skipItem('${item.result_id || item.id}')">
                            ‚è≠Ô∏è Skip
                        </button>
                    </div>

                    <div class="edit-form" id="edit-${item.result_id || item.id}">
                        <div class="form-group">
                            <label class="form-label">Title:</label>
                            <input type="text" class="form-input" id="edit-title-${item.result_id || item.id}" value="${title}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description:</label>
                            <textarea class="form-textarea" id="edit-description-${item.result_id || item.id}">${description}</textarea>
                        </div>
                        <div class="form-actions">
                            <button class="action-btn btn-save" onclick="pipelineManager.saveEdit('${item.result_id || item.id}')">
                                üíæ Save
                            </button>
                            <button class="action-btn btn-cancel" onclick="pipelineManager.cancelEdit('${item.result_id || item.id}')">
                                ‚ùå Cancel
                            </button>
                        </div>
                    </div>
                `;

                return itemDiv;
            }

            async approveItem(itemId) {
                console.log(`approveItem called with itemId: ${itemId}`);
                await this.processApprovalDecision(itemId, 'approve');
            }

            editItem(itemId) {
                document.getElementById(`edit-${itemId}`).classList.add('active');
            }

            cancelEdit(itemId) {
                document.getElementById(`edit-${itemId}`).classList.remove('active');
            }

            async saveEdit(itemId) {
                const title = document.getElementById(`edit-title-${itemId}`).value;
                const description = document.getElementById(`edit-description-${itemId}`).value;
                
                const editedContent = {
                    title: title,
                    description: description
                };

                await this.processApprovalDecision(itemId, 'edit', editedContent);
                this.cancelEdit(itemId);
            }

            async declineItem(itemId) {
                console.log(`declineItem called with itemId: ${itemId}`);
                const notes = prompt('Reason for declining (optional):');
                await this.processApprovalDecision(itemId, 'decline', null, notes);
            }

            async skipItem(itemId) {
                await this.processApprovalDecision(itemId, 'skip');
            }

            async processApprovalDecision(itemId, action, editedContent = null, notes = '') {
                try {
                    const response = await fetch(`/api/sessions/${this.currentSessionId}/approve-item`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            item_id: itemId,
                            action: action,
                            edited_content: editedContent,
                            notes: notes
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    // Update UI
                    this.updateItemStatus(itemId, action);
                    this.decisions[itemId] = { action, editedContent, notes };
                    this.updateApprovalProgress();

                } catch (error) {
                    console.error('Error processing approval decision:', error);
                    alert(`Error processing decision: ${error.message}`);
                }
            }

            updateItemStatus(itemId, action) {
                console.log(`Updating item ${itemId} to ${action}`);
                console.log(`Looking for elements with data-item-id="${itemId}" and id="status-${itemId}"`);
                
                // Debug: List all items with data-item-id attribute
                const allItems = document.querySelectorAll('[data-item-id]');
                console.log(`Found ${allItems.length} items with data-item-id:`);
                allItems.forEach((item, index) => {
                    console.log(`  Item ${index}: data-item-id="${item.dataset.itemId}"`);
                });
                
                const itemElement = document.querySelector(`[data-item-id="${itemId}"]`);
                const statusElement = document.getElementById(`status-${itemId}`);
                
                if (!itemElement) {
                    console.error(`Item element not found for ID: ${itemId}`);
                    console.error(`Searched for: [data-item-id="${itemId}"]`);
                    return;
                }
                if (!statusElement) {
                    console.error(`Status element not found for ID: status-${itemId}`);
                    console.error(`Searched for: status-${itemId}`);
                    return;
                }
                
                // Update item styling - remove all status classes first
                itemElement.classList.remove('approved', 'declined', 'edited', 'skipped');
                if (action !== 'skip') {
                    itemElement.classList.add(action === 'edit' ? 'edited' : action);
                } else {
                    itemElement.classList.add('skipped');
                }
                
                // Update status indicator
                const statusMap = {
                    approve: { text: '‚úÖ Approved', class: 'status-approved' },
                    edit: { text: '‚úèÔ∏è Edited', class: 'status-edited' },
                    decline: { text: '‚ùå Declined', class: 'status-declined' },
                    skip: { text: '‚è≠Ô∏è Skipped', class: 'status-skipped' }
                };
                
                const status = statusMap[action];
                if (status) {
                    statusElement.textContent = status.text;
                    statusElement.className = `item-status ${status.class}`;
                    console.log(`Successfully updated status to: ${status.text}`);
                } else {
                    console.error(`Unknown action: ${action}`);
                }
            }

            updateApprovalProgress() {
                const totalItems = this.approvalData.analysis.summary.total_items;
                const reviewedItems = Object.keys(this.decisions).length;
                const approvedItems = Object.values(this.decisions).filter(d => 
                    d.action === 'approve' || d.action === 'edit'
                ).length;

                document.getElementById('approvalProgress').textContent = 
                    `${reviewedItems}/${totalItems} items reviewed (${approvedItems} approved)`;

                // Enable/disable complete button
                const completeBtn = document.getElementById('completeApprovalBtn');
                if (approvedItems > 0) {
                    completeBtn.disabled = false;
                    completeBtn.innerHTML = `üíæ Save ${approvedItems} Approved Items to Database`;
                } else {
                    completeBtn.disabled = true;
                    completeBtn.innerHTML = 'üíæ Save Approved Items to Database';
                }
            }

            async completeApproval() {
                const completeBtn = document.getElementById('completeApprovalBtn');
                const originalText = completeBtn.innerHTML;
                
                completeBtn.innerHTML = '<div class="loading" style="width: 16px; height: 16px; border-width: 2px;"></div> Saving...';
                completeBtn.disabled = true;

                try {
                    const response = await fetch(`/api/sessions/${this.currentSessionId}/complete-approval`, {
                        method: 'POST'
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();
                    
                    // Show success message
                    document.getElementById('approvalSection').innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <h2 style="color: var(--success-color); margin-bottom: 20px;">üéâ Approval Complete!</h2>
                            <p style="font-size: 1.1rem; margin-bottom: 20px;">
                                Successfully saved <strong>${result.saved_count}</strong> approved items to the database.
                                <br>
                                Total decisions processed: <strong>${result.total_decisions}</strong>
                            </p>
                            <button onclick="window.location.reload()" class="btn-complete-approval" style="background: var(--success-color);">
                                üîÑ Start New Pipeline
                            </button>
                        </div>
                    `;

                } catch (error) {
                    console.error('Error completing approval:', error);
                    completeBtn.innerHTML = originalText;
                    completeBtn.disabled = false;
                    alert(`Error completing approval: ${error.message}`);
                }
            }
        }

        // Router Agent functionality
        async executeExampleQuery(query) {
            console.log('Executing example query:', query);
            document.getElementById('routerQuery').value = query;
            await this.executeRouterQuery();
        }

        async executeRouterQuery() {
            const query = document.getElementById('routerQuery').value.trim();
            if (!query) {
                alert('Please enter a query first');
                return;
            }

            const executeBtn = document.getElementById('executeQueryBtn');
            const resultsDiv = document.getElementById('routerResults');
            const resultsContent = document.getElementById('routerResultsContent');
            
            // Show loading state
            executeBtn.innerHTML = '<div class="loading" style="width: 16px; height: 16px; border-width: 2px;"></div> Processing...';
            executeBtn.disabled = true;
            resultsDiv.style.display = 'block';
            resultsContent.innerHTML = '<div class="loading"></div><p>Analyzing query...</p>';

            try {
                const response = await fetch('/api/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query: query })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                this.displayRouterResults(result);

            } catch (error) {
                console.error('Router query error:', error);
                resultsContent.innerHTML = `
                    <div style="color: var(--error-color); text-align: center;">
                        <h3>‚ùå Query Failed</h3>
                        <p>${error.message}</p>
                        <button onclick="pipelineManager.executeRouterQuery()" class="action-btn btn-approve" style="margin-top: 15px;">
                            üîÑ Retry
                        </button>
                    </div>
                `;
            } finally {
                executeBtn.innerHTML = 'üöÄ Execute Query';
                executeBtn.disabled = false;
            }
        }

        displayRouterResults(result) {
            const resultsContent = document.getElementById('routerResultsContent');
            
            let html = `
                <div style="border-bottom: 2px solid var(--gray-300); padding-bottom: 15px; margin-bottom: 20px;">
                    <h3 style="color: var(--primary-color); margin-bottom: 10px;">üß† Query Analysis</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: var(--gray-50); padding: 12px; border-radius: 8px; border-left: 4px solid var(--info-color);">
                            <strong>Intent:</strong> ${result.intent || 'Unknown'}
                        </div>
                        <div style="background: var(--gray-50); padding: 12px; border-radius: 8px; border-left: 4px solid var(--success-color);">
                            <strong>Query Type:</strong> ${result.query_type || 'Unknown'}
                        </div>
                        <div style="background: var(--gray-50); padding: 12px; border-radius: 8px; border-left: 4px solid var(--warning-color);">
                            <strong>Confidence:</strong> ${Math.round((result.confidence || 0) * 100)}%
                        </div>
                        <div style="background: var(--gray-50); padding: 12px; border-radius: 8px; border-left: 4px solid var(--primary-color);">
                            <strong>Processing Time:</strong> ${result.processing_time || 'N/A'}
                        </div>
                    </div>
                </div>
            `;

            if (result.results && result.results.length > 0) {
                html += `
                    <h3 style="color: var(--success-color); margin-bottom: 15px;">üìä Results (${result.results.length} items)</h3>
                    <div style="max-height: 400px; overflow-y: auto; border: 1px solid var(--gray-300); border-radius: 8px;">
                `;

                result.results.forEach((item, index) => {
                    const confidence = item.confidence_score || item.confidence || 0;
                    const confidenceClass = confidence >= 0.8 ? 'high' : confidence >= 0.6 ? 'medium' : 'low';
                    
                    html += `
                        <div style="border-bottom: 1px solid var(--gray-200); padding: 15px; ${index % 2 === 0 ? 'background: var(--gray-50);' : ''}">
                            <div style="display: flex; justify-content: between; align-items: flex-start; margin-bottom: 8px;">
                                <h4 style="margin: 0; color: var(--gray-800); flex: 1;">${item.content?.title || item.content?.task || 'Untitled'}</h4>
                                <span class="confidence-badge ${confidenceClass}" style="margin-left: 10px;">${Math.round(confidence * 100)}%</span>
                            </div>
                            <p style="margin: 5px 0; color: var(--gray-600); line-height: 1.4;">
                                ${item.content?.description || item.content?.details || 'No description available'}
                            </p>
                            <div style="display: flex; gap: 15px; font-size: 0.85rem; color: var(--gray-500); margin-top: 8px;">
                                <span>Category: ${item.category || 'Unknown'}</span>
                                ${item.similarity_score ? `<span>Similarity: ${Math.round(item.similarity_score * 100)}%</span>` : ''}
                                <span>Chunks: ${item.chunk_ids?.length || 0}</span>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
            } else {
                html += `
                    <div style="text-align: center; padding: 30px; color: var(--gray-500);">
                        <h3>üîç No Results Found</h3>
                        <p>Try rephrasing your query or using different keywords.</p>
                    </div>
                `;
            }

            // Add usage suggestions
            html += `
                <div style="margin-top: 20px; padding: 15px; background: var(--info-color-light); border-radius: 8px; border-left: 4px solid var(--info-color);">
                    <h4 style="margin: 0 0 10px 0; color: var(--info-color);">üí° Query Tips</h4>
                    <ul style="margin: 5px 0; padding-left: 20px; color: var(--gray-700);">
                        <li>Try queries like: "Find items similar to [keyword]"</li>
                        <li>Ask for statistics: "How many items in each category?"</li>
                        <li>Look for patterns: "Analyze planning trends"</li>
                        <li>Find duplicates: "Show duplicate planning items"</li>
                    </ul>
                </div>
            `;

            resultsContent.innerHTML = html;
        }

        // Initialize the pipeline manager when the page loads
        let pipelineManager;
        document.addEventListener('DOMContentLoaded', () => {
            pipelineManager = new PipelineManager();
            
            // Set up Router Agent event listeners
            document.getElementById('executeQueryBtn').addEventListener('click', () => {
                pipelineManager.executeRouterQuery();
            });
            
            document.getElementById('routerQuery').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    pipelineManager.executeRouterQuery();
                }
            });
            
            // Check for session_id parameter in URL
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session_id');
            if (sessionId) {
                // Load existing session
                pipelineManager.loadExistingSession(sessionId);
            }
        });
    </script>
</body>
</html>